<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>sandboxRADIO BETA</title>
    <style>
        :root {
            --chassis-bg: #2b2b2b;
            --panel-bg: #1a1a1a;
            --text-main: #d1d1d1;
            --display-bg: #0f172a;
            --display-text: #38bdf8;
            --accent-color: #ea580c;
            --mode-active: #10b981;
            --mode-danger: #ef4444;
            --btn-gradient-top: #404040;
            --btn-gradient-bottom: #262626;
            --border-light: #525252;
            --border-dark: #000000;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .radio-chassis {
            width: 98%; max-width: 1400px; height: 96vh;
            background: var(--chassis-bg); border-radius: 12px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1), 0 10px 30px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; padding: 10px;
            position: relative; border: 4px solid #000;
        }

        .screw { position: absolute; width: 10px; height: 10px; background: #111; border-radius: 50%; box-shadow: inset 0 1px 2px rgba(255,255,255,0.2); z-index: 5; }
        .tl { top: 5px; left: 5px; } .tr { top: 5px; right: 5px; } .bl { bottom: 5px; left: 5px; } .br { bottom: 5px; right: 5px; }

        .top-deck {
            display: flex; gap: 8px; padding: 8px; border-bottom: 2px solid #000; margin-bottom: 8px;
            align-items: center; background: #222; border-radius: 6px; box-shadow: inset 0 0 10px #000; flex-wrap: wrap;
        }
        .logo { font-weight: 900; font-size: 1.2rem; color: var(--text-main); letter-spacing: 1px; margin-right: auto; text-shadow: 0 2px 0 #000; font-style: italic; }
        .logo span { color: var(--accent-color); }
        .logo .beta-badge { color: #10b981; font-size: 0.7rem; margin-left: 8px; border: 1px solid #10b981; padding: 2px 6px; border-radius: 3px; font-weight: bold; }

        .btn {
            background: linear-gradient(to bottom, var(--btn-gradient-top), var(--btn-gradient-bottom));
            color: #e5e5e5; border: 1px solid #000; border-top: 1px solid var(--border-light);
            padding: 6px 12px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase;
            border-radius: 4px; cursor: pointer; box-shadow: 0 3px 0 #000; transition: transform 0.1s;
            white-space: nowrap; text-align: center; display: inline-block;
        }
        .btn:active { transform: translateY(3px); box-shadow: 0 0 0 #000; }
        .btn-help { color: var(--accent-color); border-color: #664400; }
        /* KO-FI STYLE */
        .btn-donate { color: #ff5f5f; border-color: #552222; }
        .version-display {
            color: #666;
            font-size: 0.6rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin-left: 6px;
            display: inline-block;
            vertical-align: middle;
        }
        .btn-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .mobile-text { display: none; }
        .desktop-text { display: inline; }

        input[type="file"] { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

        .player-deck {
            height: auto; background: #222; margin-bottom: 10px; border-radius: 8px;
            border: 2px solid #000; box-shadow: inset 0 0 20px #000; display: flex;
            align-items: center; padding: 10px; gap: 10px; flex-shrink: 0;
            position: relative; z-index: 20;
        }
        .speaker-grill {
            width: 30px; height: 80px; flex-shrink: 0;
            background-image: radial-gradient(#000 20%, transparent 20%);
            background-size: 3px 3px; border-radius: 4px; box-shadow: inset 0 0 10px #000;
        }
        .player-controls-wrapper { flex: 1; display: flex; flex-direction: column; gap: 8px; min-width: 0; }

        /* LCD DISPLAY */
        .lcd-display {
            background: var(--display-bg); border: 2px solid #444; border-radius: 4px;
            padding: 6px 10px; 
            display: flex; flex-direction: column; gap: 2px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8); position: relative;
            overflow: hidden;
        }
        .lcd-row { display: flex; align-items: center; width: 100%; position: relative; }
        .lcd-glass { position: absolute; top:0; left:0; right:0; bottom:0; pointer-events: none; background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%); z-index: 20; }
        .time-readout { font-family: 'Courier New', monospace; color: var(--display-text); font-weight: bold; min-width: 110px; font-size: 0.8rem; margin-right: 10px; }
        .marquee-container { width: 100%; overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-inner { display: inline-block; font-family: 'Courier New', monospace; color: #2a7a9e; font-size: 0.7rem; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; animation: marquee 10s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: var(--display-text); cursor: pointer; -webkit-appearance: none; margin-top: -6px; box-shadow: 0 0 5px rgba(56, 189, 248, 0.5); }
        #scrubber { width: 100%; flex: 1; }

        .transport-row { display: flex; justify-content: center; gap: 6px; align-items: center; flex-wrap: wrap;}
        .transport-btn {
            width: 38px; height: 38px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #444, #111);
            border: 2px solid #000; box-shadow: 0 3px 3px rgba(0,0,0,0.5);
            color: #fff; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 0.85rem; transition: all 0.1s;
        }
        .transport-btn:active { transform: scale(0.95); background: #222; }
        .transport-btn.play-large { width: 48px; height: 48px; font-size: 1.2rem; color: var(--accent-color); border-color: #333; }
        .btn-top { font-size: 0.7rem; font-weight: bold; letter-spacing: 1px; color: var(--accent-color); border-color: #555; }

        .test-end-group { display: flex; align-items: center; background: #333; border: 1px solid #000; border-radius: 4px; padding: 2px; height: 28px; margin-left: 5px; }
        .util-btn { background: transparent; color: #aaa; border: none; font-size: 0.65rem; padding: 0 8px; cursor: pointer; text-transform: uppercase; height: 100%; }
        .util-btn:hover { color: #fff; }
        .test-input { width: 45px; background: #222; color: #38bdf8; border: none; text-align: center; font-family: monospace; font-size: 0.8rem; height: 100%; border-left: 1px solid #444; }
        .test-input:focus { outline: none; background: #000; }

        /* VOLUME GROUP */
        .volume-group {
            display: flex; align-items: center; background: #222; border: 1px solid #444;
            border-radius: 4px; padding: 0 8px; height: 28px; margin-left: 10px;
        }
        .vol-label { font-size: 0.6rem; font-weight: bold; color: #888; margin-right: 6px; }
        #volumeSlider { width: 80px; }
        #volumeSlider::-webkit-slider-thumb { background: #10b981; box-shadow: 0 0 5px #10b981; }
        
        /* METER BRIDGE */
        .meter-bridge {
            display: flex; gap: 2px; align-items: center; margin-left: 5px;
            background: #0a0a0a; padding: 2px; border-radius: 4px;
            border: 1px solid #333; flex-shrink: 0;
        }
        .lufs-box {
            background: #0f172a; border: 1px solid #444; border-radius: 2px;
            height: 24px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 5px; font-family: 'Courier New', monospace;
            color: #555; font-weight: bold; font-size: 0.7rem;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.8); width: 60px;
        }
        .lufs-box.wide { width: 76px; }
        .lufs-box.active { color: var(--mode-active); text-shadow: 0 0 5px rgba(16,185,129,0.5); }
        .lufs-box.phase-alert { color: var(--mode-danger); text-shadow: 0 0 5px rgba(239,68,68,0.5); border-color: var(--mode-danger); }
        .lufs-label { font-size: 0.6rem; opacity: 0.7; color: #aaa; margin-right: 2px; }
        .val-readout { text-align: right; flex: 1; }

        /* VERTICAL STACK FOR VU + MAX */
        .vu-stack {
            display: flex; flex-direction: column; height: 30px;
            margin-left: 4px; min-width: 90px;
        }

        /* VU METER (Top Part) */
        .vu-group {
            display: flex; flex-direction: column; gap: 1px; 
            height: 12px; width: 100%;
            background: #050505; padding: 1px; border: 1px solid #333; border-bottom: none;
            border-radius: 2px 2px 0 0; position: relative;
        }
        .vu-ch { flex: 1; background: #1a1a1a; position: relative; border-radius: 1px; overflow: hidden; display:flex; }
        
        .vu-bar {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #10b981 60%, #f59e0b 85%, #ef4444 100%);
            box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
            -webkit-mask-image: repeating-linear-gradient(90deg, #000, #000 3px, transparent 3px, transparent 4px);
            mask-image: repeating-linear-gradient(90deg, #000, #000 3px, transparent 3px, transparent 4px);
            transition: width 0.05s linear;
        }
        
        .peak-hold { position: absolute; top: 0; height: 100%; width: 2px; background: #fff; opacity: 0.8; z-index: 5; display: none; }
        .clip-led { width: 8px; height: 100%; background: #330000; border-left: 1px solid #000; flex-shrink: 0; }
        .clip-led.latched { background: #ff0000; box-shadow: 0 0 8px #ff0000; }

        /* MAX CONTROLS (Bottom Part) */
        .max-row {
            display: flex; align-items: center; 
            height: 18px; width: 100%;
            background: #0f172a; border: 1px solid #333; border-radius: 0 0 2px 2px;
            padding: 0 4px;
        }
        
        .max-col-left {
            display: flex; flex-direction: column; justify-content: center;
            margin-right: 6px; width: 22px; border-right: 1px solid #333;
            height: 100%;
        }
        
        .max-label { font-size: 0.45rem; color: #888; font-weight:bold; font-family: sans-serif; line-height: 1; margin-bottom: 1px; text-transform: uppercase;}
        
        .reset-btn {
            background: transparent; border: none; color: #ef4444;
            font-size: 0.5rem; padding: 0; text-align: left;
            cursor: pointer; font-weight: bold; font-family: sans-serif;
            line-height: 1;
        }
        .reset-btn:hover { color: #fff; text-decoration: underline; }

        .max-val { font-family: 'Courier New', monospace; font-size: 0.7rem; color: #38bdf8; font-weight: bold; flex: 1; text-align: right; }

        .mode-btn { 
            font-size: 0.65rem; padding: 0 8px; height: 28px; margin-left: 5px;
            border: 1px solid #444; background: #222; color: #666; border-radius: 4px; 
            cursor: pointer; font-weight: bold; text-transform: uppercase;
        }
        .mode-btn.active { 
            background: #064e3b; color: var(--mode-active); border-color: var(--mode-active);
            box-shadow: 0 0 5px rgba(16, 185, 129, 0.3);
        }
        .mode-btn.disabled { opacity: 0.4; cursor: not-allowed; border-color: #222; color: #444; box-shadow: none; }

        /* ANALYSIS LAB */
        #analysisLab {
            background: #000; border: 2px solid #333; border-top: none;
            margin: -12px 0 10px 0; border-radius: 0 0 8px 8px;
            height: 0; overflow: hidden; transition: height 0.3s ease;
            position: relative; z-index: 10; display: flex; flex-direction: column;
        }
        #analysisLab.open { height: 200px; border-color: #000; box-shadow: inset 0 0 20px rgba(0,0,0,0.9); }
        
        .lab-tabs { display: flex; background: #111; border-bottom: 1px solid #333; }
        .lab-tab { 
            flex: 1; padding: 4px; font-size: 0.65rem; text-align: center; color: #666; 
            cursor: pointer; border-right: 1px solid #222; text-transform: uppercase; font-weight: bold;
        }
        .lab-tab.active { color: var(--accent-color); background: #000; box-shadow: inset 0 -2px 0 var(--accent-color); }
        
        .lab-viewport { flex: 1; position: relative; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }
        
        .scope-controls {
            position: absolute; top: 5px; right: 5px; z-index: 60;
            background: rgba(0,0,0,0.7); padding: 4px; border-radius: 4px;
            display: none; align-items: center; border: 1px solid #333;
        }
        .scope-controls span { font-size: 0.6rem; color: #fff; margin-right: 5px; font-weight: bold; }
        #scopeZoom { width: 80px; height: 4px; }
        
        .util-toggle {
            background: #222; border: 1px solid #555; color: #fff; font-size: 0.6rem;
            padding: 2px 6px; cursor: pointer; margin-left: 10px; border-radius: 2px;
        }
        .util-toggle:hover { border-color: var(--accent-color); }

        .spectrum-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            color: #666; font-family: monospace; font-weight: bold; pointer-events: none; z-index: 50;
        }

        .dashboard { 
            display: grid; grid-template-columns: 260px 1fr 260px; gap: 10px; 
            flex: 1; overflow: hidden; min-height: 0;
            transition: grid-template-columns 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dashboard.minimized { grid-template-columns: 50px 1fr 260px; }
        .dashboard.minimized #libraryPanel .hide-when-minimized { display: none; }
        
        .panel-frame {
            background: var(--panel-bg); border: 2px solid #000; border-radius: 6px;
            display: flex; flex-direction: column; box-shadow: inset 0 0 15px rgba(0,0,0,0.8); 
            height: 100%; overflow: hidden; transition: height 0.3s ease;
        }
        .panel-frame.collapsed #library-list { display: none; }
        .panel-header {
            background: #111; color: #888; padding: 8px; font-size: 0.7rem;
            text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333;
            display: flex; align-items: center; min-height: 32px; flex-shrink: 0;
            white-space: nowrap; overflow: hidden;
        }
        .panel-footer {
            background: #000; color: var(--display-text); padding: 6px 10px; font-size: 0.8rem;
            border-top: 1px solid #333; text-align: right; font-family: 'Courier New', monospace;
            font-weight: bold; min-height: 30px; display: flex; align-items: center; justify-content: flex-end;
        }
        .action-txt { color: var(--accent-color); cursor: pointer; font-weight: bold; font-size: 0.7rem; margin-left: 10px;}
        .action-txt.danger { color: #ef4444; }
        .toggle-text { color: #fff; cursor: pointer; font-family: monospace; font-weight: bold; margin-right: 10px; font-size: 1rem; }
        .toggle-text:hover { color: var(--accent-color); }
        .scroll-area { flex: 1; overflow-y: auto; padding: 5px; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; }
        .scroll-area::-webkit-scrollbar { width: 6px; background: #111; }
        .scroll-area::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        .track-item, .preset-item {
            background: #2a2a2a; margin-bottom: 3px; padding: 8px; border-radius: 4px;
            font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; border-left: 3px solid transparent; color: #aaa;
            user-select: none; min-height: 40px; touch-action: pan-y; 
        }
        .track-item:hover, .preset-item:hover { background: #333; color: white; }
        .track-item.active { background: #2d3035; border-left: 3px solid var(--accent-color); color: var(--accent-color); }
        .track-item.dragging { opacity: 0.5; background: #444; }
        .track-item.drag-target { border-top: 2px solid var(--accent-color); }
        .preset-item { font-size: 0.8rem; min-height: 35px; border-left: 3px solid #444; color: #999; }
        .preset-item:hover { border-left-color: #fff; }
        
        .icon-group { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
        .icon-btn { font-weight: bold; width: 24px; height: 24px; display:flex; align-items:center; justify-content:center; opacity: 0.6; cursor: pointer; font-size: 1.2rem; }
        .icon-btn:hover { opacity: 1; color: white; background: rgba(255,255,255,0.1); border-radius: 50%; }
        .move-btn { font-size: 0.8rem; color: #888; } .move-btn:hover { color: #fff; }
        .remove-btn { color: #ef4444; } .add-btn { color: #10b981; }
        .trunc-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0; margin-right: 5px; }
        .gap-input { width: 50px; background: #111; color: #38bdf8; border: 1px solid #444; text-align: center; font-family: monospace; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px; margin-left: 5px; }
        .gap-input:focus { outline: none; border-color: var(--accent-color); }
        .gap-label { font-size: 0.65rem; color: #888; margin-right: 3px; }
        
        #resetDBBtn { position: absolute; bottom: 5px; right: 5px; opacity: 0.2; font-size: 0.6rem; color: red; cursor: pointer; z-index: 10; }
        #resetDBBtn:hover { opacity: 1; }
        
        #exportOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .export-box {
            background: #222; border: 2px solid var(--accent-color); border-radius: 8px; padding: 20px;
            width: 90%; max-width: 320px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,1);
        }
        .export-title { color: #fff; font-weight: bold; font-size: 1.1rem; text-align: center; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .export-label { color: #aaa; font-size: 0.8rem; }
        .export-input { 
            background: #111; border: 1px solid #555; color: #fff; padding: 10px; 
            font-size: 1rem; border-radius: 4px; width: 100%; font-family: monospace;
        }
        .export-input:focus { outline: none; border-color: var(--accent-color); }
        .export-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .action-btn {
            padding: 12px; border: none; border-radius: 4px; font-weight: bold; 
            text-transform: uppercase; cursor: pointer; color: white; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-confirm { background: var(--accent-color); box-shadow: 0 4px 0 #a33d05; color: black; }
        .btn-confirm:active { transform: translateY(2px); box-shadow: 0 2px 0 #a33d05; }
        .btn-copy { background: #3b82f6; color: white; box-shadow: 0 4px 0 #1d4ed8; }
        .btn-copy:active { transform: translateY(2px); box-shadow: 0 2px 0 #1d4ed8; }
        .btn-cancel { background: #444; color: #aaa; margin-top: 5px; }

        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 4px; padding: 12px; position: fixed;
            z-index: 2000; bottom: 30px; left: 50%; transform: translateX(-50%);
            border: 1px solid var(--accent-color); box-shadow: 0 0 20px rgba(0,0,0,1);
            font-weight: bold; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
            font-family: 'Courier New', monospace; letter-spacing: 1px;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 60px; }

        /* DEBUG OVERLAY */
        #debugOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 3000; display: none;
            align-items: center; justify-content: center; padding: 20px;
        }
        .debug-box {
            background: #1a1a1a; border: 2px solid var(--accent-color); border-radius: 8px;
            width: 90%; max-width: 800px; max-height: 80vh;
            display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(234, 88, 12, 0.5);
        }
        .debug-header {
            background: #222; padding: 12px 15px; border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center; border-radius: 6px 6px 0 0;
        }
        .debug-title { color: var(--accent-color); font-weight: bold; font-size: 1.1rem; letter-spacing: 1px; }
        .debug-controls { display: flex; gap: 8px; }
        .debug-btn {
            background: #333; color: #fff; border: 1px solid #555; padding: 4px 10px;
            border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: bold;
            text-transform: uppercase; transition: all 0.2s;
        }
        .debug-btn:hover { background: #444; border-color: var(--accent-color); }
        .debug-content {
            padding: 15px; overflow-y: auto; flex: 1; font-family: 'Courier New', monospace;
            font-size: 0.85rem; color: #d1d1d1; line-height: 1.6;
        }
        .debug-log-entry {
            padding: 4px 0; border-bottom: 1px solid #2a2a2a; display: flex; gap: 10px;
        }
        .debug-timestamp { color: #888; min-width: 80px; font-size: 0.8rem; }
        .debug-message { color: #38bdf8; flex: 1; }



        @media (max-width: 1000px) {
            .radio-chassis { height: 100vh; border-radius: 0; border: none; padding: 5px; width: 100%; }
            .dashboard, .dashboard.minimized { display: flex; flex-direction: column; overflow-y: auto; flex: 1; grid-template-columns: none; }
            .dashboard.minimized #libraryPanel .hide-when-minimized { display: inline; }
            .panel-frame { flex: none; height: 220px; margin-bottom: 5px; min-height: 40px; }
            .panel-frame:nth-child(2) { flex: 1; min-height: 250px; }
            .panel-frame.collapsed { height: auto !important; min-height: 40px; flex: none; }
            .panel-frame.collapsed .panel-header { border-bottom: none; }
            .player-deck { padding: 5px; gap: 5px; }
            .speaker-grill { display: none; }
            .logo { font-size: 1rem; }
            .btn { padding: 4px 8px; font-size: 0.7rem; }
            .track-item, .preset-item { padding: 6px 4px; }
            .icon-group { gap: 5px; }
            .top-deck { justify-content: center; }
            .btn-group { flex-wrap: wrap; justify-content: center; }
            .mobile-text { display: inline; }
            .desktop-text { display: none; }
        }
    </style>
</head>
<body>

<div class="radio-chassis">
    <div class="screw tl"></div><div class="screw tr"></div><div class="screw bl"></div><div class="screw br"></div>
    <div id="resetDBBtn">FACTORY RESET</div>

    <div id="exportOverlay">
        <div class="export-box">
            <div class="export-title">Backup System</div>
            <div>
                <div class="export-label">Filename</div>
                <input type="text" id="exportFilename" class="export-input" value="sandboxRADIO_Backup">
            </div>
            <div class="export-actions">
                <button class="action-btn btn-confirm" id="btnActionSave"><span>ðŸ’¾ Save to File</span></button>
                <button class="action-btn btn-copy" id="btnActionCopy"><span>ðŸ“‹ Copy to Clipboard</span></button>
                <button class="action-btn btn-cancel" id="btnActionCancel">Cancel</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:50;display:none;align-items:center;justify-content:center;color:white;font-family:monospace;font-size:1.2rem;font-weight:bold;">Processing...</div>

    <div class="top-deck">
        <div class="logo">sandbox<span>RADIO</span><span class="beta-badge">BETA</span><span id="versionTag" class="version-display"></span></div>
        <div class="btn-group">
            <button class="btn" id="btnLoadFolder"><span class="desktop-text">Load Folder</span><span class="mobile-text">Folder</span></button>
            <input type="file" id="folderInput" webkitdirectory directory multiple>
            <button class="btn" id="btnLoadFiles"><span class="desktop-text">Load Files</span><span class="mobile-text">Files</span></button>
            <input type="file" id="fileInput" multiple accept=".wav">
        </div>
        <div class="btn-group">
            <button class="btn" id="exportBtn"><span class="desktop-text">Backup System</span><span class="mobile-text">Backup</span></button>
            <button class="btn" id="btnImport"><span class="desktop-text">Restore Backup</span><span class="mobile-text">Restore</span></button>
            <input type="file" id="importInput" accept=".json,application/json,text/json">
        </div>
        <div class="btn-group">
            <button class="btn btn-donate" id="btnDonate">Donate</button>
            <button class="btn btn-help" id="btnHelp" onclick="window.open('sandboxradio_help.html', '_blank')">Help</button>
            <button class="btn" id="btnGitHub" onclick="window.open('https://github.com/blackcarburning/sandboxRADIO', '_blank')">GitHub</button>
            <button class="btn" id="btnDebug">DEBUG</button>
        </div>
    </div>

    <div class="player-deck">
        <div class="speaker-grill speaker-left"></div>
        <div class="player-controls-wrapper">
            <div class="lcd-display">
                <div class="lcd-glass"></div>
                <div class="lcd-row">
                    <span class="time-readout" id="time-display">0:00 / 0:00</span>
                    <input type="range" id="scrubber" value="0" min="0" step="0.1">
                </div>
                <div class="lcd-row">
                    <div class="marquee-container">
                        <span id="track-title-display" class="marquee-inner">---</span>
                    </div>
                </div>
            </div>
            
            <div class="transport-row">
                <button class="transport-btn btn-top" id="playAllBtn" title="Play from Start">TOP</button>
                <button class="transport-btn" id="prevTrackBtn">|&lt;</button>
                <button class="transport-btn" id="rewindBtn">&laquo;</button>
                <button class="transport-btn" id="stopBtn">â– </button>
                <button class="transport-btn play-large" id="playBtn">â–¶</button>
                <button class="transport-btn" id="forwardBtn">&raquo;</button>
                <button class="transport-btn" id="nextTrackBtn">&gt;|</button>
                <div class="test-end-group">
                    <button class="util-btn" id="testEndBtn" title="Play last X seconds">Test End</button>
                    <input type="number" id="testEndInput" class="test-input" value="10" title="Seconds from end" autocomplete="off">
                </div>
                <button id="toggleLabBtn" class="mode-btn disabled" title="Toggle Analysis Lab">LAB</button>
                <button id="monoBtn" class="mode-btn">MONO</button>
                <button id="toggleAnalysisBtn" class="mode-btn">Analysis: OFF</button>
                
                <div class="meter-bridge">
                    <div class="lufs-box" id="lufsDisplay" title="Momentary LUFS"><span class="lufs-label">M</span><span id="lufsValue" class="val-readout">---</span></div>
                    <div class="lufs-box" id="lufsIntegratedDisplay" title="Integrated LUFS"><span class="lufs-label">I</span><span id="lufsIntegratedValue" class="val-readout">---</span></div>
                    <div class="lufs-box" id="plrDisplay" title="Peak-to-Loudness Ratio"><span class="lufs-label">PLR</span><span id="plrValue" class="val-readout">---</span></div>
                    <div class="lufs-box wide" id="phaseDisplay" title="Correlation / Phase (-1.0 to +1.0)"><span class="lufs-label">CORR</span><span id="phaseValue" class="val-readout">---</span></div>
                    
                    <div class="vu-stack" id="vuStack">
                        <div class="vu-group" title="Click meter to Reset">
                            <div class="vu-ch"><div class="vu-bar" id="vuL"></div><div class="peak-hold" id="phL"></div><div class="clip-led" id="clipL"></div></div>
                            <div class="vu-ch"><div class="vu-bar" id="vuR"></div><div class="peak-hold" id="phR"></div><div class="clip-led" id="clipR"></div></div>
                        </div>
                        <div class="max-row">
                            <div class="max-col-left">
                                <span class="max-label">MAX</span>
                                <button id="btnResetPeak" class="reset-btn" title="Reset Peak">RST</button>
                            </div>
                            <span id="maxPeakValue" class="max-val">---</span>
                        </div>
                    </div>
                </div>

                <div class="volume-group" id="vol-control-container">
                    <span class="vol-label">VOL (POST)</span>
                    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" autocomplete="off">
                </div>
            </div>
        </div>
        <div class="speaker-grill speaker-right"></div>
    </div>

    <!-- ANALYSIS LAB -->
    <div id="analysisLab">
        <div class="lab-tabs">
            <div class="lab-tab active" data-tab="spectrum">Spectrum</div>
            <div class="lab-tab" data-tab="scope">Scope</div>
            <div class="lab-tab" data-tab="vector">Vector</div>
            <div class="lab-tab" data-tab="waterfall">Waterfall</div>
        </div>
        <div class="lab-viewport">
            <div class="scope-controls" id="scopeControls">
                <span class="scope-ui-only">Timebase (10ms - 5s)</span>
                <input type="range" id="scopeZoom" class="scope-ui-only" min="10" max="5000" step="10" value="10">
                <button id="spectrumModeBtn" class="util-toggle spectrum-ui-only">VIEW: L/R</button>
            </div>
            <canvas id="mainCanvas"></canvas>
            <canvas id="waterfallCanvas" style="display:none;"></canvas>
            <div class="spectrum-overlay" id="spectrumOverlay">ANALYSIS MODE REQUIRED</div>
        </div>
    </div>

    <div class="dashboard" id="mainDashboard">
        <div class="panel-frame" id="libraryPanel">
            <div class="panel-header">
                <span class="toggle-text" id="toggleLibBtn" title="Minimize">[-]</span>
                <span class="hide-when-minimized" style="flex:1">Library</span>
                <span class="action-txt danger hide-when-minimized" id="clearLibraryBtn">EJECT ALL</span>
            </div>
            <div id="library-list" class="scroll-area"><div style="padding:20px; text-align:center; opacity:0.5;">NO MEDIA LOADED</div></div>
        </div>

        <div class="panel-frame">
            <div class="panel-header"><span>Active Queue</span><span class="action-txt" id="clearPlaylistBtn">CLEAR</span></div>
            <div id="playlist-list" class="scroll-area"></div>
            <div class="panel-footer" id="total-time-display">Queue: 0 Tracks</div>
        </div>

        <div class="panel-frame">
            <div class="panel-header"><span>Presets</span><span class="action-txt" id="savePresetBtn">SAVE NEW</span></div>
            <div id="preset-list" class="scroll-area"></div>
        </div>
    </div>
</div>

<div id="toast">Requires Analysis Mode</div>

<div id="debugOverlay">
    <div class="debug-box">
        <div class="debug-header">
            <div class="debug-title">DEBUG LOG</div>
            <div class="debug-controls">
                <button class="debug-btn" id="btnDebugRefresh">REFRESH</button>
                <button class="debug-btn" id="btnDebugCopy">COPY</button>
                <button class="debug-btn" id="btnDebugClose">CLOSE</button>
            </div>
        </div>
        <div class="debug-content" id="debugContent">
            <div style="text-align: center; color: #666; padding: 20px;">No logs yet. Events will appear here.</div>
        </div>
    </div>
</div>

<script>
    const APP_VERSION = 'v1.1.26-BETA';
    const DB_NAME = 'RadioWavDB';
    
    // DEBUG LOGGING
    let appLogs = [];
    function log(msg) {
        const timestamp = new Date().toLocaleTimeString();
        appLogs.push({ time: timestamp, message: msg });
        console.log(`[${timestamp}] ${msg}`);
    }
    
    // HTML escape function to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    const DB_VERSION = 7;
    const STORE_PLAYLIST = 'playlist';
    const STORE_LIBRARY = 'library';
    const STORE_PRESETS = 'presets';
    const STORE_SETTINGS = 'settings';



    // Constants
    const DEFAULT_GAP_SECONDS = 2.0;
    const MAX_GAP_SECONDS = 60;
    const SILENT_WAV_DATA_URI = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';
    
    let db, playlistFiles = [], currentTrackIndex = -1, isDraggingScrubber = false;
    let testEndTime = 10;
    let pendingExportData = null; 
    let seekOnLoadPending = false;
    
    // Helper function to get gap value with fallback
    function getGapValue(track) {
        return track && track.gap !== undefined ? track.gap : DEFAULT_GAP_SECONDS;
    }
    
    // --- AUDIO ENGINE ---
    let isAnalysisMode = false;
    let isMono = false;
    let currentAudio = null;
    let silentAudio = new Audio(); // Dedicated silent audio player for iOS gap management
    let audioCtx = null;
    
    let stereoPath = null, monoPath = null, preMaster = null, masterGain = null; 
    let analyser = null; 
    let splitter = null;
    let analyserL = null, analyserR = null; 
    
    let mergerMS = null;
    let gainMid = null;
    let gainSide = null;
    let analyserMid = null;
    let analyserSide = null;

    let mediaSource = null;
    let scriptProcessor = null;
    let rafID = null;        

    // Stats & Config
    let integratedSum = 0;
    let integratedCount = 0;
    let activeTab = 'spectrum';
    let spectrumModeMS = false; 
    
    // VU Meter Physics
    let decayL = 0, decayR = 0;
    let peakHoldL = 0, peakHoldR = 0;
    let peakHoldTimerL = 0, peakHoldTimerR = 0;
    let maxPeakDb = -100;
    
    // SCOPE RING BUFFER
    const HISTORY_SIZE = 500000; 
    const scopeBuffer = new Float32Array(HISTORY_SIZE);
    let scopeWritePos = 0;
    let scopeTimebase = 10; // ms

    // UI References
    const libraryList = document.getElementById('library-list');
    const playlistList = document.getElementById('playlist-list');
    const presetList = document.getElementById('preset-list');
    const scrubber = document.getElementById('scrubber');
    const timeDisplay = document.getElementById('time-display');
    const trackTitleDisplay = document.getElementById('track-title-display');
    const totalTimeDisplay = document.getElementById('total-time-display');
    const playBtn = document.getElementById('playBtn');
    const monoBtn = document.getElementById('monoBtn');
    const testEndInput = document.getElementById('testEndInput');
    const volumeSlider = document.getElementById('volumeSlider');
    const volContainer = document.getElementById('vol-control-container');
    
    const toggleAnalysisBtn = document.getElementById('toggleAnalysisBtn');
    const toggleLabBtn = document.getElementById('toggleLabBtn');
    const analysisLab = document.getElementById('analysisLab');
    const spectrumOverlay = document.getElementById('spectrumOverlay');
    const mainCanvas = document.getElementById('mainCanvas');
    const waterfallCanvas = document.getElementById('waterfallCanvas');
    
    const scopeControls = document.getElementById('scopeControls');
    const scopeZoomSlider = document.getElementById('scopeZoom');
    const spectrumModeBtn = document.getElementById('spectrumModeBtn');
    
    const lufsBox = document.getElementById('lufsDisplay');
    const lufsValue = document.getElementById('lufsValue');
    const lufsIntBox = document.getElementById('lufsIntegratedDisplay');
    const lufsIntValue = document.getElementById('lufsIntegratedValue');
    const plrBox = document.getElementById('plrDisplay');
    const plrValue = document.getElementById('plrValue');
    const phaseBox = document.getElementById('phaseDisplay');
    const phaseValue = document.getElementById('phaseValue');
    
    const vuL = document.getElementById('vuL');
    const vuR = document.getElementById('vuR');
    const phL = document.getElementById('phL');
    const phR = document.getElementById('phR');
    const clipL = document.getElementById('clipL');
    const clipR = document.getElementById('clipR');
    const vuStack = document.getElementById('vuStack');
    const maxPeakValue = document.getElementById('maxPeakValue');
    const btnResetPeak = document.getElementById('btnResetPeak');
    
    const loadingOverlay = document.getElementById('loadingOverlay');
    const exportOverlay = document.getElementById('exportOverlay');
    const exportFilename = document.getElementById('exportFilename');
    const toggleLibBtn = document.getElementById('toggleLibBtn');
    const libraryPanel = document.getElementById('libraryPanel');
    const mainDashboard = document.getElementById('mainDashboard');

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    if (isIOS) volContainer.style.display = 'none';

    // --- SCRUBBER EVENT LISTENERS ---
    scrubber.addEventListener('input', () => { isDraggingScrubber = true; updateTimeDisplay(scrubber.value); });
    scrubber.addEventListener('change', () => { 
        if(currentAudio) { 
            // Ensure audio context is active when scrubbing ends
            if(isAnalysisMode && audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => log('Context resumed on scrubber change'));
            }
            currentAudio.currentTime = scrubber.value; 
            isDraggingScrubber = false; 
        } 
    });
    scrubber.addEventListener('mousedown', () => isDraggingScrubber = true);
    scrubber.addEventListener('touchstart', () => isDraggingScrubber = true, {passive: true});
    scrubber.addEventListener('mouseup', () => isDraggingScrubber = false);
    scrubber.addEventListener('touchend', () => isDraggingScrubber = false);

    function showToast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg; t.classList.add("show");
        setTimeout(() => { t.classList.remove("show"); }, 3000);
    }

    // --- TAB UI LOGIC ---
    function updateLabTabUI() {
        document.querySelectorAll('.lab-tab').forEach(t => t.classList.remove('active'));
        const currentTabBtn = document.querySelector(`.lab-tab[data-tab="${activeTab}"]`);
        if(currentTabBtn) currentTabBtn.classList.add('active');

        // UI Toggle Logic - Explicitly run this every time
        document.querySelectorAll('.scope-ui-only').forEach(el => el.style.display = activeTab === 'scope' ? 'inline-block' : 'none');
        document.querySelectorAll('.spectrum-ui-only').forEach(el => el.style.display = activeTab === 'spectrum' ? 'inline-block' : 'none');
        scopeControls.style.display = (activeTab === 'scope' || activeTab === 'spectrum') ? 'flex' : 'none';
        
        if(activeTab === 'waterfall') {
            mainCanvas.style.display = 'none'; waterfallCanvas.style.display = 'block';
        } else {
            mainCanvas.style.display = 'block'; waterfallCanvas.style.display = 'none';
        }
    }

    document.querySelectorAll('.lab-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            activeTab = tab.dataset.tab;
            updateLabTabUI();
        });
    });
    
    // SCOPE ZOOM & PERSISTENCE
    scopeZoomSlider.addEventListener('input', (e) => { 
        scopeTimebase = parseInt(e.target.value); 
    });
    scopeZoomSlider.addEventListener('change', (e) => {
        if(db) db.transaction([STORE_SETTINGS], 'readwrite').objectStore(STORE_SETTINGS).put({ key: 'scopeTimebase', value: parseInt(e.target.value) });
    });
    
    // SPECTRUM MODE TOGGLE
    spectrumModeBtn.addEventListener('click', () => {
        spectrumModeMS = !spectrumModeMS;
        spectrumModeBtn.textContent = spectrumModeMS ? "VIEW: M/S" : "VIEW: L/R";
        spectrumModeBtn.style.borderColor = spectrumModeMS ? "var(--accent-color)" : "#555";
        spectrumModeBtn.style.color = spectrumModeMS ? "var(--accent-color)" : "#fff";
    });

    toggleLabBtn.addEventListener('click', () => {
        if (!isAnalysisMode) { showToast("Enable Analysis Mode First"); return; }
        analysisLab.classList.toggle('open');
        toggleLabBtn.classList.toggle('active');
        updateLabTabUI(); // Ensure UI is correct when opening
    });
    
    monoBtn.addEventListener('click', () => {
        if (!isAnalysisMode) { showToast("Requires Analysis Mode"); return; }
        isMono = !isMono;
        if(isMono) { monoBtn.classList.add('active'); if(stereoPath && monoPath) { stereoPath.gain.value = 0; monoPath.gain.value = 1; } } 
        else { monoBtn.classList.remove('active'); if(stereoPath && monoPath) { stereoPath.gain.value = 1; monoPath.gain.value = 0; } }
    });
    
    // RESET CLIP LOGIC
    function resetMaxPeak() {
        maxPeakDb = -100;
        maxPeakValue.textContent = "---";
        clipL.classList.remove('latched');
        clipR.classList.remove('latched');
    }
    
    vuStack.addEventListener('click', (e) => { 
        if(e.target.id !== 'btnResetPeak') resetMaxPeak(); 
    });
    btnResetPeak.addEventListener('click', (e) => { 
        e.stopPropagation(); resetMaxPeak(); 
    });

    function showLoading(msg) { loadingOverlay.style.display = 'flex'; loadingOverlay.textContent = msg || 'Processing...'; }
    function hideLoading() { loadingOverlay.style.display = 'none'; }

    function setupAudioEvents(audioObj) {
        audioObj.addEventListener('play', () => { 
            log('currentAudio: play event');
            playBtn.innerHTML = '&#10074;&#10074;';
            // Always attempt to resume context on play event
            ensureAudioContextActive();
        });
        audioObj.addEventListener('pause', () => { 
            log('currentAudio: pause event');
            playBtn.innerHTML = 'â–¶'; 
        });
        audioObj.addEventListener('stalled', () => { 
            log('currentAudio: stalled event');
        });
        audioObj.addEventListener('suspend', () => { 
            log('currentAudio: suspend event');
        });
        audioObj.addEventListener('error', (e) => { 
            log('currentAudio: error event - ' + (e.message || 'Unknown error'));
        });
        audioObj.addEventListener('ended', async () => { 
            try {
                if (currentTrackIndex >= 0 && currentTrackIndex + 1 < playlistFiles.length) {
                    const currentTrack = playlistFiles[currentTrackIndex];
                    const gapSeconds = getGapValue(currentTrack);
                    log(`Track ended. Waiting ${gapSeconds}s before next track`);
                    
                    // iOS fix: Play silent audio during gap to keep audio session active
                    if (isIOS) {
                        silentAudio.loop = true;
                        silentAudio.play().catch(e => log('Silent audio play failed: ' + e));
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, gapSeconds * 1000));
                    
                    // iOS fix: Stop silent audio before next track
                    if (isIOS) {
                        silentAudio.pause();
                        silentAudio.currentTime = 0; // Reset for next time
                    }
                    
                    await playTrack(currentTrackIndex + 1);
                } else { 
                    scrubber.value = 0; 
                }
            } catch(e) {
                log('Error in ended handler: ' + String(e));
            }
        });
        audioObj.addEventListener('timeupdate', () => { if (!isDraggingScrubber) { scrubber.value = audioObj.currentTime; updateTimeDisplay(); } });
        audioObj.addEventListener('loadedmetadata', () => {
            scrubber.max = audioObj.duration; updateTimeDisplay();
            if (seekOnLoadPending) {
                let sec = parseInt(document.getElementById('testEndInput').value) || 10;
                if(audioObj.duration) { audioObj.currentTime = Math.max(0, audioObj.duration - sec); }
                seekOnLoadPending = false;
            }
        });
    }

    function createNewAudioPlayer() {
        if(currentAudio) { currentAudio.pause(); currentAudio.src = ""; currentAudio.load(); currentAudio = null; }
        currentAudio = new Audio(); 
        currentAudio.crossOrigin = "anonymous"; 
        currentAudio.playsInline = true;
        setupAudioEvents(currentAudio);
    }
    
    // --- AUDIO CONTEXT PERSISTENCE HELPER ---
    // Forces the AudioContext to resume if it is suspended or interrupted (common on iOS lock screen or switching apps)
    async function ensureAudioContextActive() {
        if (!isAnalysisMode || !audioCtx) return;
        
        if (audioCtx.state === 'suspended' || audioCtx.state === 'interrupted') {
            log(`AudioContext state is '${audioCtx.state}'. Attempting resume...`);
            try {
                await audioCtx.resume();
                log(`AudioContext resume success. State is now: ${audioCtx.state}`);
            } catch (err) {
                log(`AudioContext resume failed: ${err}`);
            }
        }
    }

    // Monitor Visibility Change to recover audio on unlock/foreground
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            log('App Foregrounded. Checking AudioContext...');
            ensureAudioContextActive();
        }
    });

    toggleAnalysisBtn.addEventListener('click', () => {
        if(currentAudio) { currentAudio.pause(); currentAudio.src = ""; }
        playBtn.innerHTML = 'â–¶'; scrubber.value = 0; updateTimeDisplay(0); seekOnLoadPending = false;

        if (!isAnalysisMode) {
            if (isIOS && !confirm("ENABLE ANALYSIS MODE?\n\n- Volume Slider: ON\n- Background Audio: OFF")) return;
            isAnalysisMode = true;
            toggleAnalysisBtn.textContent = "Analysis: ON"; toggleAnalysisBtn.classList.add('active');
            lufsBox.classList.add('active'); lufsIntBox.classList.add('active'); plrBox.classList.add('active'); phaseBox.classList.add('active');
            spectrumOverlay.style.display = 'none'; toggleLabBtn.classList.remove('disabled');
            if(isIOS) volContainer.style.display = 'flex';
            createNewAudioPlayer(); 
            initWebAudio().catch(e => log('Error in initWebAudio: ' + String(e))); 
            updateLabTabUI();
        } else {
            isAnalysisMode = false;
            toggleAnalysisBtn.textContent = "Analysis: OFF"; toggleAnalysisBtn.classList.remove('active');
            lufsBox.classList.remove('active'); lufsIntBox.classList.remove('active'); plrBox.classList.remove('active'); phaseBox.classList.remove('active');
            lufsValue.textContent = "---"; lufsIntValue.textContent = "---"; plrValue.textContent = "---"; phaseValue.textContent = "---";
            phaseBox.classList.remove('phase-alert'); spectrumOverlay.style.display = 'flex';
            vuL.style.width = '0%'; vuR.style.width = '0%'; phL.style.display = 'none'; phR.style.display = 'none';
            resetMaxPeak();
            toggleLabBtn.classList.add('disabled');
            if(analysisLab.classList.contains('open')) { analysisLab.classList.remove('open'); toggleLabBtn.classList.remove('active'); }
            if(isIOS) volContainer.style.display = 'none';
            if(isMono) { isMono = false; monoBtn.classList.remove('active'); }
            stopAnalysisLoop();
            if(audioCtx) { audioCtx.close().catch(e=>console.log(e)); audioCtx = null; masterGain = null; mediaSource = null; }
            createNewAudioPlayer();
        }
        updateVolume();
    });

    async function initWebAudio() {
        log('initWebAudio: Starting initialization');
        if (audioCtx && audioCtx.state === 'closed') { 
            log('initWebAudio: Found closed context, nullifying');
            audioCtx = null; 
        }
        if (!audioCtx) {
            // FRESH START: Recreate HTMLAudioElement to match new AudioContext
            if (currentAudio && currentAudio.src) {
                log('initWebAudio: Player Swap - saving state');
                let savedTime = currentAudio.currentTime;
                let savedSrc = currentAudio.src;
                
                log('initWebAudio: Recreating HTMLAudioElement');
                currentAudio = new Audio();
                currentAudio.crossOrigin = "anonymous";
                currentAudio.playsInline = true;
                setupAudioEvents(currentAudio);
                currentAudio.src = savedSrc;
                
                // Set currentTime after metadata loads to avoid timing issues
                currentAudio.addEventListener('loadedmetadata', () => {
                    if (savedTime > 0) {
                        currentAudio.currentTime = savedTime;
                    }
                }, { once: true });
                
                log('initWebAudio: Recreated HTMLAudioElement to match new AudioContext');
            }
            
            log('initWebAudio: Creating new AudioContext');
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            
            // Add state change listener for debugging and recovery
            audioCtx.onstatechange = () => {
                log(`AudioContext state changed to: ${audioCtx.state}`);
            };

            // KICKSTART: Briefly play silence to force the hardware to wake up
            try {
                const warmUp = audioCtx.createBufferSource();
                warmUp.buffer = audioCtx.createBuffer(1, 1, 22050); // 22050Hz = half of standard 44.1kHz
                warmUp.connect(audioCtx.destination);
                warmUp.onended = () => warmUp.disconnect(); // Clean up after playback
                warmUp.start(0);
            } catch(e) {
                log('Warm-up buffer failed: ' + String(e));
            }
            log('initWebAudio: Created new AudioContext');
            
            stereoPath = audioCtx.createGain(); 
            monoPath = audioCtx.createGain(); monoPath.channelCount = 1; monoPath.channelCountMode = 'clamped-max'; 
            preMaster = audioCtx.createGain(); preMaster.channelCount = 2; preMaster.channelCountMode = 'explicit'; 
            masterGain = audioCtx.createGain();
            masterGain.gain.value = volumeSlider.value;
            
            mediaSource = audioCtx.createMediaElementSource(currentAudio);
            mediaSource.connect(stereoPath); mediaSource.connect(monoPath);
            stereoPath.connect(preMaster); monoPath.connect(preMaster);
            preMaster.connect(masterGain); masterGain.connect(audioCtx.destination);
            
            analyser = audioCtx.createAnalyser(); analyser.fftSize = 16384; analyser.smoothingTimeConstant = 0.85;
            masterGain.connect(analyser);
            
            splitter = audioCtx.createChannelSplitter(2);
            preMaster.connect(splitter);
            
            analyserL = audioCtx.createAnalyser(); analyserL.fftSize = 2048;
            analyserR = audioCtx.createAnalyser(); analyserR.fftSize = 2048;
            splitter.connect(analyserL, 0); splitter.connect(analyserR, 1);
            
            const midSum = audioCtx.createGain();
            const sideSum = audioCtx.createGain();
            splitter.connect(midSum, 0); splitter.connect(midSum, 1);
            splitter.connect(sideSum, 0);
            const inverter = audioCtx.createGain(); inverter.gain.value = -1;
            splitter.connect(inverter, 1); inverter.connect(sideSum);
            
            analyserMid = audioCtx.createAnalyser(); analyserMid.fftSize = 16384; analyserMid.smoothingTimeConstant = 0.85;
            analyserSide = audioCtx.createAnalyser(); analyserSide.fftSize = 16384; analyserSide.smoothingTimeConstant = 0.85;
            
            midSum.connect(analyserMid); sideSum.connect(analyserSide);

            scriptProcessor = audioCtx.createScriptProcessor(4096, 1, 1);
            scriptProcessor.connect(audioCtx.destination); 
            scriptProcessor.onaudioprocess = (e) => {
                if(!isAnalysisMode) return;
                const input = e.inputBuffer.getChannelData(0);
                for (let i = 0; i < input.length; i++) {
                    scopeBuffer[scopeWritePos] = input[i];
                    scopeWritePos = (scopeWritePos + 1) % HISTORY_SIZE;
                }
            };
            preMaster.connect(scriptProcessor);
        }
    }

